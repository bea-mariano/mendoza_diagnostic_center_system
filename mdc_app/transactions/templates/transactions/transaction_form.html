<!DOCTYPE html>
<html>
<head>
    <title>{% if form.instance.pk %}Edit{% else %}Create{% endif %} Transaction</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        /* Ensure all elements use the same box sizing */
        *, *:before, *:after { box-sizing: border-box; }
        body { font-family: "Segoe UI", Arial, sans-serif; background-color: #f5f5f5; margin: 0; padding: 20px; }
        .container { max-width: 1200px; background-color: #fff; margin: 0 auto; padding: 30px 40px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15); }
        h1 { text-align: center; margin-bottom: 20px; }
        .nav { margin-bottom: 20px; text-align: left; }
        .nav a { color: #007BFF; text-decoration: none; font-weight: bold; margin: 0 10px; }
        .nav a:hover { text-decoration: underline; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 6px; font-weight: bold; color: #333; }
        input[type="text"], input[type="email"], input[type="date"], input[type="number"], textarea, select {
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.95rem; transition: border-color 0.3s;
        }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #007BFF; }
        textarea { resize: vertical; height: 120px; }
        input[disabled], select[disabled] { background-color: #e9ecef; color: #555; }
        button { background-color: #007BFF; color: #fff; padding: 12px 20px; border: none; border-radius: 4px; font-size: 1rem; cursor: pointer; transition: background-color 0.3s; width: 100%; }
        button:hover { background-color: #0056b3; }
        fieldset { border: 1px solid #ccc; border-radius: 4px; padding: 15px; margin-bottom: 20px; }
        legend { padding: 0 10px; font-weight: bold; color: #007BFF; }
        .tests-container { display: grid; grid-template-columns: 1fr; gap: 10px; }
        @media (min-width: 768px) { .tests-container { grid-template-columns: 1fr 1fr 1fr; gap: 16px; } }
        .test-option { display: flex; align-items: center; }
        .test-option input[type="checkbox"] { margin-right: 8px; transform: scale(1.2); }
        .error { color: #d9534f; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="nav">
        <a href="{% url 'transaction_list' %}">← Back to Transaction List</a>
    </div>
    <div class="container">
        <h1>{% if form.instance.pk %}Edit{% else %}Create{% endif %} Transaction</h1>
        <form method="POST" data-pk="{{ form.instance.pk|default_if_none:'' }}">
            {% csrf_token %}

            <!-- Patient Information -->
            <fieldset>
                <legend>Patient Information</legend>
                <div class="form-group"><label for="patient">Patient</label>{{ form.patient }}</div>
                <div class="form-group"><label for="address">Address</label>{{ form.address }}</div>
                <div class="form-group"><label for="contact_no">Contact Number</label>{{ form.contact_no }}</div>
                <div class="form-group"><label for="age">Age</label>{{ form.age }}</div>
            </fieldset>

            <!-- Transaction Details -->
            <fieldset>
                <legend>Transaction Details</legend>
                <div class="form-group"><label for="transaction_type">Transaction Type</label>{{ form.transaction_type }}</div>
                <div class="form-group"><label for="company_id">Company</label>{{ form.company }}</div>
                <input type="hidden" id="id_company_peme_rate" value="{{ form.instance.company.company_peme_rate|default:0 }}">
                <div class="form-group"><label for="transaction_purpose">Package Name (Select CUSTOM TEST if OPD)</label>
                    <select id="id_transaction_purpose" name="transaction_purpose">
                        <option value="">Select Purpose</option>
                    </select>
                </div>
                <div class="form-group"><label for="transaction_status">Transaction Status</label>{{ form.transaction_status }}</div>
                <div class="form-group"><label for="payment_type">Payment Type</label>{{ form.payment_type }}</div>
                <div class="form-group"><label for="has_drug_test">Has Drug Test</label>{{ form.has_drug_test }}</div>
                <div class="form-group"><label for="custody_control_form_submitted">Custody Control Form Submitted</label>{{ form.custody_control_form_submitted }}</div>
            </fieldset>

            <!-- Test Selection -->
            <fieldset>
                <legend>Test Selection</legend>
                <div class="form-group"><label for="tests">Tests</label>
                    <div class="tests-container">
                        {% for test in form.fields.tests.queryset %}
                        <div class="test-option">
                            <input type="checkbox" name="tests" value="{{ test.pk }}" id="test_{{ test.pk }}" data-price="{{ test.test_price }}"{% if test.pk in form.tests.value %} checked{% endif %}>
                            <label for="test_{{ test.pk }}">{{ test.test_name }} (₱{{ test.test_price }})</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </fieldset>

            <!-- Discounts & Totals -->
            <fieldset>
                <legend>Discounts & Totals</legend>
                <div class="form-group"><label for="discount_type">Discount Type</label>{{ form.discount_type }}</div>
                <div class="form-group"><label for="discount_rate">Discount Rate</label>{{ form.discount_rate }}</div>
                <div class="form-group"><label for="transaction_total">Transaction Total</label>{{ form.transaction_total }}</div>
                <div class="form-group"><label for="discounted_total">Discounted Total</label>{{ form.discounted_total }}</div>
            </fieldset>

            {% if form.errors %}<div class="error">{{ form.errors }}</div>{% endif %}
            <button type="submit">Save Transaction</button>
        </form>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // --- AGE AUTO-CALCULATION SETUP ---
            // 1) Build a map of patient-ID → birthday (YYYY-MM-DD)
            const patientBirthdays = {
                {% for patient in patients %}
                "{{ patient.pk }}": "{{ patient.date_of_birth|date:'Y-m-d' }}"{% if not forloop.last %},{% endif %}
                {% endfor %}
            };

            // 2) Grab the DOM nodes
            const patientSelect = document.getElementById("id_patient");
            const ageField      = document.getElementById("id_age");

            // 3) Age calculation helper
            function calculateAge(dob) {
                const today = new Date();
                let age = today.getFullYear() - dob.getFullYear();
                const m = today.getMonth() - dob.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
                    age--;
                }
                return age;
            }

            // 4) On patient change, look up DOB, compute & set age
            patientSelect.addEventListener("change", function(){
                const dobStr = patientBirthdays[this.value];
                if (dobStr) {
                    const [y, m, d] = dobStr.split('-').map(Number);
                    ageField.value = calculateAge(new Date(y, m - 1, d));
                } else {
                    ageField.value = '';
                }
            });

            // 5) If editing an existing transaction, fire the change once on load
            if (patientSelect.value) {
                patientSelect.dispatchEvent(new Event('change'));
            }

            // --- 1) Globals to hold exclusion amounts and the current promo price ---
            let exclusionMap = {};
            let currentPromoPrice = null;
        
            // --- 2) Element references ---
            const companySelect           = document.getElementById("id_company");
            const transactionPurposeField = document.getElementById("id_transaction_purpose");
            const testCheckboxes          = document.querySelectorAll("input[name='tests']");
            const discountTypeField       = document.getElementById("id_discount_type");
            const discountRateField       = document.getElementById("id_discount_rate");
            const transactionTotalField   = document.getElementById("id_transaction_total");
            const companyPemeRateField    = document.getElementById("id_company_peme_rate");
            const discountedTotalField    = document.getElementById("id_discounted_total");
        
            // --- 3) Core calculator ---
            function calculateTestTotal(promoPrice) {

                // decide base price (either the passed promo or the hidden field)
                const basePrice = promoPrice != null
                    ? promoPrice
                    : (parseInt(companyPemeRateField.value, 10) || 0);
                console.log("basePrice:", basePrice);
        
                let total = 0;
                const purpose = transactionPurposeField.value;
        
                if (purpose === "CUSTOM TEST") {
                    // sum only the checked tests' own prices
                    testCheckboxes.forEach(cb => {
                        if (cb.checked) {
                            total += parseInt(cb.dataset.price, 10) || 0;
                        }
                    });
                } else {
                    // start at the promo/base, subtract each unchecked exclusion
                    total = basePrice;
                    testCheckboxes.forEach(cb => {
                        if (!cb.checked) {
                            total -= exclusionMap[cb.value] || 0;
                        }
                    });
                }
        
                console.log("calculated total:", total);
                return total;
            }
        
            // --- 4) Update helpers ---
            function updateTransactionTotal(promoPrice) {
                console.log("updateTransactionTotal with promoPrice:", promoPrice);
                transactionTotalField.value = calculateTestTotal(promoPrice);
            }
        
            function updateDiscountRate() {
                const type      = discountTypeField.value;
                const baseTotal = parseInt(transactionTotalField.value, 10) || 0;
        
                if (type === "Philhealth") {
                    discountRateField.value = 500;
                } else if (type === "Senior Citizen" || type === "PWD") {
                    discountRateField.value = Math.round(baseTotal * 0.2);
                } else if (type === "No Discount") {
                    discountRateField.value = 0;
                } else {
                    discountRateField.value = "";
                }
            }
        
            function updateDiscountedTotal() {
                const baseTotal = parseInt(transactionTotalField.value, 10) || 0;
                let rate        = parseInt(discountRateField.value, 10) || 0;
        
                if (discountTypeField.value === "Senior Citizen" || discountTypeField.value === "PWD") {
                    rate = Math.round(baseTotal * 0.2);
                    discountRateField.value = rate;
                }
        
                const finalTotal = baseTotal - rate;
                discountedTotalField.value = finalTotal >= 0 ? finalTotal : 0;
            }
        
            // --- 5) Fetch and reload purposes ---
            function reloadPurposes() {
                const companyId = companySelect.value;
                transactionPurposeField.innerHTML = '<option value="">Select Purpose</option>';
                if (!companyId) return;
        
                fetch(`/setpackages/ajax/get-available-transaction-purposes/${companyId}/`)
                    .then(res => {
                        if (!res.ok) throw new Error(res.statusText);
                        return res.json();
                    })
                    .then(data => {
                        data.purposes.forEach(p => {
                            const opt = document.createElement("option");
                            opt.value = p;
                            opt.textContent = p;
                            if (p === "{{ form.initial.transaction_purpose|escapejs }}") {
                                opt.selected = true;
                            }
                            transactionPurposeField.appendChild(opt);
                        });
                        // trigger a change so the rest of the logic runs
                        transactionPurposeField.dispatchEvent(new Event("change"));
                    })
                    .catch(err => console.error("Error loading purposes:", err));
            }
        
            // --- 6) Handlers ---
        
            // When company changes, reload purposes and get the P E M E rate
            companySelect.addEventListener("change", function() {
                reloadPurposes();
                const cid = companySelect.value;
                if (!cid) return;
        
                fetch(`/transactions/ajax/get-company-peme-rate/${cid}/`)
                    .then(res => res.json())
                    .then(data => {
                        companyPemeRateField.value = data.peme_rate || 0;
                        // recalc using no promo override (will read hidden field)
                        updateTransactionTotal(null);
                        updateDiscountRate();
                        updateDiscountedTotal();
                    })
                    .catch(() => {
                        companyPemeRateField.value = 0;
                        updateTransactionTotal(null);
                        updateDiscountRate();
                        updateDiscountedTotal();
                    });
            });
        
            // When purpose changes, fetch tests + exclusion, then (if package) fetch promo price
            transactionPurposeField.addEventListener("change", function() {
                const purpose   = transactionPurposeField.value;
                const companyId = companySelect.value;
        
                // always reset transactional fields first
                updateTransactionTotal(null);
                updateDiscountRate();
                updateDiscountedTotal();
        
                if (!(purpose && companyId)) return;
        
                // 1) get tests + exclusion_amount
                fetch(`/setpackages/ajax/get-tests-by-purpose/${companyId}/${encodeURIComponent(purpose)}/`)
                    .then(res => res.json())
                    .then(data => {
                        exclusionMap = {};
                        data.test_ids.forEach(item => {
                            exclusionMap[String(item.test_id)] = parseFloat(item.exclusion_amount) || 0;
                        });
        
                        // check the defaults
                        const ids = Object.keys(exclusionMap);
                        testCheckboxes.forEach(cb => {
                            cb.checked = ids.includes(cb.value);
                        });
        
                        // 2) if it’s a package, fetch its promo price
                        if (purpose !== "CUSTOM TEST") {
                            fetch(`/setpackages/ajax/get-package-price/?purpose=${encodeURIComponent(purpose)}&company_id=${companyId}`)
                                .then(res => res.json())
                                .then(pkg => {
                                    // store the promo once
                                    currentPromoPrice = pkg.promo_price != null
                                        ? Math.round(pkg.promo_price)
                                        : 0;
                                    // use it to initialize the field & recalc
                                    updateTransactionTotal(currentPromoPrice);
                                    updateDiscountRate();
                                    updateDiscountedTotal();
                                })
                                .catch(err => {
                                    console.error("Error loading promo price:", err);
                                    currentPromoPrice = null;
                                });
                        } else {
                            // custom test → no promo
                            currentPromoPrice = null;
                            updateTransactionTotal(null);
                            updateDiscountRate();
                            updateDiscountedTotal();
                        }
                    })
                    .catch(err => console.error("Error loading tests:", err));
            });
        
            // When discount type changes
            discountTypeField.addEventListener("change", function() {
                updateDiscountRate();
                updateDiscountedTotal();
            });
        
            // When user manually edits discount rate
            discountRateField.addEventListener("input", updateDiscountedTotal);
        
            // 7) **KEY**: Listen for user check/uncheck of tests
            testCheckboxes.forEach(cb =>
            cb.addEventListener("change", function() {
                // only on uncheck
                if (!cb.checked) {
                const testId = cb.value;
                // find the <label> text and strip off the price in parentheses
                const labelEl = document.querySelector(`label[for="${cb.id}"]`);
                const rawText = labelEl ? labelEl.textContent : testId;
                const testName = rawText.split(" (")[0]; 

                const exclusionAmt = exclusionMap[testId] || 0;
                const purpose = transactionPurposeField.value;

                console.log(
                    `${testId} ${testName} WITH EXCLUSION AMOUNT OF ${exclusionAmt} REMOVED FROM ${purpose}`
                );
                }

                // then do your normal recalc
                console.log("Checkbox changed — using promoPrice:", currentPromoPrice);
                updateTransactionTotal(currentPromoPrice);
                updateDiscountRate();
                updateDiscountedTotal();
            })
            );

        
            // 8) Form submit defaults
            document.querySelector("form").addEventListener("submit", function() {
                if (!document.getElementById("id_payment_type").value)
                    document.getElementById("id_payment_type").value = "Cash";
                if (!document.getElementById("id_transaction_status").value)
                    document.getElementById("id_transaction_status").value = "Ongoing";
                if (isNaN(parseInt(discountRateField.value, 10))) discountRateField.value = 0;
                if (isNaN(parseInt(transactionTotalField.value, 10))) transactionTotalField.value = 0;
                if (isNaN(parseInt(discountedTotalField.value, 10))) discountedTotalField.value = 0;
            });
        
            // --- 9) Initial load: only on CREATE pages ---
            const isEdit = !!document.querySelector("form").dataset.pk;
            if (!isEdit) {
                // on a NEW transaction we need to load package → tests → promoPrice → recalc
                reloadPurposes();
            }
        });
    </script>
        
</body>
</html>