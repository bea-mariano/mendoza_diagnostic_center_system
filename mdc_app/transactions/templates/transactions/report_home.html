{% extends 'base.html' %}
{% load static %}

{% block title %}Reports{% endblock %}

{% block extra_head %}
<style>
  .container {
      max-width: 80%;
      margin: 15px auto 30px auto;
      padding: 30px 40px;
  }

  h1 {
      text-align: center;
      margin-bottom: 40px;
      font-size: 2rem;
  }

  .btn {
    background-color: #4CAF50;
    color: #fff;
    padding: 12px 20px;
    border: none;
    border-radius: 4px;
    text-decoration: none;
    font-size: 1rem;
    white-space: nowrap;
  }

  .btn-action {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      width: 40px;
      height: 40px;
      font-size: 1rem;
      border-radius: 4px;
      color: #fff;
      text-decoration: none;
      border: none;
      cursor: pointer;
  }

  .btn-view { background-color: #4CAF50; }
  .btn-edit { background-color: #FFC107; }
  .btn-print { background-color: #17A2B8; }
  .btn-delete { background-color: #DC3545; }

  table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
  }

  th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #ccc;
  }

  th {
      background-color: #007BFF;
      color: white;
  }

  tr:hover {
      background-color: #f5f5f5;
  }

  th:nth-last-child(-n+4),
  td:nth-last-child(-n+4) {
      width: 10%;
      text-align: center;
  }

  .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
  }

  .modal-content {
      background-color: #fff;
      margin: 10% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80mm;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  }

  .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
  }

  .close:hover,
  .close:focus {
      color: #000;
      text-decoration: none;
  }

  @media print {
      @page { size: 80mm auto; margin: 0; }
      body * { visibility: hidden; }
      #receiptModal, #receiptModal * { visibility: visible; }
      #receiptModal {
          position: absolute; top: 0; left: 0;
          width: 100%; background: #fff; z-index: 9999;
          display: block !important;
      }
      .modal-content {
          width: 60mm; margin: 0 auto;
          padding: 10px; border: none; box-shadow: none;
      }
      .no-print { display: none !important; }
  }

  .action-group {
    display: flex;
    justify-content: flex-end;
    gap: 6px;
  }

  .col-transaction-id { width: 4%; }

  .btn-lab { background-color: #6F42C1; }

  .tab-container {
      margin-top: 20px;
  }

  .tab-menu {
      display: flex;
      border-bottom: 2px solid #007BFF;
      margin-bottom: 10px;
  }

  .tab {
      padding: 10px 20px;
      cursor: pointer;
      background: #f1f1f1;
      border: 1px solid #ccc;
      border-bottom: none;
      margin-right: 4px;
      border-top-left-radius: 6px;
      border-top-right-radius: 6px;
      font-weight: bold;
      color: #007BFF;
      transition: background-color 0.3s;
  }

  .tab:hover {
      background-color: #e0e0e0;
  }

  .tab.active {
      background-color: #fff;
      border-color: #007BFF #007BFF #fff;
      color: #000;
  }

  .tab-content {
      border: 1px solid #ccc;
      padding: 20px;
      background: #fff;
      border-radius: 0 6px 6px 6px;
  }

  .content-pane {
      display: none;
  }

  .content-pane.active {
      display: block;
  }

</style>
{% endblock %}

{% block content %}
<div class="container">
  <h1>Reports</h1>

  <!-- ðŸ” Shared Filter Form -->
  <form method="get" style="margin: 20px 0; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
    <label for="start_date">Start Date:</label>
    <input type="date" name="start_date" value="{{ start_date }}" style="padding:6px; border:1px solid #ccc; border-radius:4px;">

    <label for="end_date">End Date:</label>
    <input type="date" name="end_date" value="{{ end_date }}" style="padding:6px; border:1px solid #ccc; border-radius:4px;">

    <label for="payment_type">Payment Type:</label>
    <select name="payment_type" style="padding:6px; border:1px solid #ccc; border-radius:4px;">
      <option value="">All</option>
      <option value="Cash" {% if payment_type == 'Cash' %}selected{% endif %}>Cash</option>
      <option value="Charged" {% if payment_type == 'Charged' %}selected{% endif %}>Charged</option>
    </select>

    <button type="submit" class="btn">Filter</button>
  </form>

  <div class="tab-container">
    <!-- Tabs -->
    <div class="tab-menu">
      <div class="tab active" data-target="pane-transactions">Philhealth</div>
      <div class="tab" data-target="pane-summary">Summary</div>
    </div>

    <div class="tab-content">
      <!-- ðŸ“‹ Philhealth Tab -->
      <div id="pane-transactions" class="content-pane active">
        <div style="text-align: right; margin-bottom: 10px;">
          <button class="btn btn-print" onclick="printPhilhealthReport()">Print Philhealth Report</button>
        </div>

        {% if transactions %}
        <table>
          <thead>
            <tr>
              <th></th>
              <th>Txn ID</th>
              <th>Date</th>
              <th>Patient</th>
              <th>Philhealth Type</th>
              <th>Discount</th>
              <th>Discounted Total</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for transaction in transactions %}
              {% if transaction.is_philhealth or transaction.is_philhealth_free %}
              <tr
                data-transaction-id="{{ transaction.id }}"
                data-patient-name="{{ transaction.patient.last_name }}, {{ transaction.patient.first_name }}"
                data-contact="{{ transaction.contact_no }}"
                data-company="{{ transaction.company }}"
                data-purpose="{{ transaction.transaction_purpose }}"
                data-transaction-date="{{ transaction.transaction_date }}"
                data-transaction-time="{{ transaction.transaction_time }}"
                data-transaction-status="{{ transaction.get_transaction_status_display }}"
                data-payment-type="{{ transaction.get_payment_type_display }}"
                data-transaction-type="{{ transaction.get_transaction_type_display }}"
                data-discount-type="{{ transaction.get_discount_type_display }}"
                data-discount-rate="â‚± {{ transaction.discount_rate }}"
                data-transaction-total="â‚± {{ transaction.transaction_total }}"
                data-discounted-total="â‚± {{ transaction.discounted_total }}"
                data-is-philhealth="{{ transaction.is_philhealth }}"
                data-is-philhealth-free="{{ transaction.is_philhealth_free }}"
                data-test-details="{% for tt in transaction.transaction_tests.all %}{{ tt.test.test_name }} - â‚±{{ tt.test_price }}{% if not forloop.last %}, {% endif %}{% endfor %}"
              >
                <td><a href="{% url 'transaction_detail' transaction.id %}" class="btn-view btn-action"><i class="fas fa-eye"></i></a></td>
                <td>{{ transaction.id }}</td>
                <td>{{ transaction.transaction_date }}</td>
                <td>{{ transaction.patient.last_name }}, {{ transaction.patient.first_name }}</td>
                <td>
                  {% if transaction.is_philhealth %}Philhealth{% endif %}
                  {% if transaction.is_philhealth_free %}{% if transaction.is_philhealth %}<br>{% endif %}Philhealth Free{% endif %}
                </td>
                <td>{{ transaction.discount_rate }}</td>
                <td>{{ transaction.discounted_total }}</td>
                <td>{{ transaction.transaction_status }}</td>
              </tr>
              {% endif %}
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <p>No transactions found for the selected filters.</p>
        {% endif %}
      </div>

      <!-- ðŸ“Š Summary Tab -->
      <div id="pane-summary" class="content-pane">
        <h2>Report Summary</h2>

        {% if transactions %}
        <table>
          <thead>
            <tr>
              <th>Txn ID</th>
              <th>Date</th>
              <th>Patient</th>
              <th>Payment Type</th>
              <th>Total</th>
              <th>Discount</th>
              <th>Discounted Total</th>
            </tr>
          </thead>
          <tbody>
            {% for transaction in transactions %}
            <tr>
              <td>{{ transaction.id }}</td>
              <td>{{ transaction.transaction_date }}</td>
              <td>{{ transaction.patient.last_name }}, {{ transaction.patient.first_name }}</td>
              <td>{{ transaction.payment_type }}</td>
              <td>â‚± {{ transaction.transaction_total }}</td>
              <td>â‚± {{ transaction.discount_rate }}</td>
              <td>â‚± {{ transaction.discounted_total }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <p>No transactions match the selected filters.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Tab switching logic
    const tabs  = document.querySelectorAll('.tab-menu .tab');
    const panes = document.querySelectorAll('.content-pane');

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        panes.forEach(p => p.classList.remove('active'));

        tab.classList.add('active');
        const targetPane = document.getElementById(tab.dataset.target);
        if (targetPane) {
          targetPane.classList.add('active');
        } else {
          console.error('Pane not found:', tab.dataset.target);
        }
      });
    });

    // Receipt-printing functions
    const logoUrl = "{% static 'images/mdc_logo.jpg' %}";

    window.printAcknowledgementReceipt = function(transactionId) {
      const row = document.querySelector('tr[data-transaction-id="' + transactionId + '"]');
      if (row) {
        let basicTableHtml = "<div style='text-align:center; margin-bottom:10px;'><img src='" + logoUrl + "' style='width:60px; height:auto;'></div>";
        basicTableHtml += "<h2 style='text-align:center; margin-bottom:5px;'>Mendoza Diagnostic Center</h2>";
        basicTableHtml += "<h4 style='text-align:center;'>Acknowledgement Receipt</h4>";
        basicTableHtml += "<table style='width:100%; border-collapse:collapse; margin-bottom:20px;'>" +
          "<tr><td style='padding:8px;'>Transaction ID</td><td style='padding:8px;'>" + row.getAttribute("data-transaction-id") + "</td></tr>" +
          "<tr><td style='padding:8px;'>Patient Name</td><td style='padding:8px;'>" + row.getAttribute("data-patient-name") + "</td></tr>" +
          "<tr><td style='padding:8px;'>Contact Number</td><td style='padding:8px;'>" + row.getAttribute("data-contact") + "</td></tr>" +
          "<tr><td style='padding:8px;'>Company</td><td style='padding:8px;'>" + row.getAttribute("data-company") + "</td></tr>" +
          "<tr><td style='padding:8px;'>Package Name</td><td style='padding:8px;'>" + row.getAttribute("data-purpose") + "</td></tr>" +
          "<tr><td style='padding:8px;'>Transaction Date</td><td style='padding:8px;'>" + row.getAttribute("data-transaction-date") + "</td></tr>" +
          "<tr><td style='padding:8px;'>Transaction Time</td><td style='padding:8px;'>" + row.getAttribute("data-transaction-time") + "</td></tr>" +
          "<tr><td style='padding:8px;'>Transaction Status</td><td style='padding:8px;'>Completed</td></tr>" +
          "</table>";

        const testDetails = row.getAttribute("data-test-details");
        let testTableHtml = "";
        if (testDetails) {
          testTableHtml += "<h3 style='text-align:center;'>Test Details</h3>" +
            "<table style='width:100%; border-collapse:collapse; margin-bottom:20px;'>" +
            "<tr><th style='padding:8px;'>Test Name</th><th style='padding:8px;'>Test Price</th></tr>";
          testDetails.split(",").forEach(item => {
            const [name, price] = item.split(" - ");
            testTableHtml += `<tr><td style='padding:8px;'>${name.trim()}</td><td style='padding:8px;'>${price.trim()}</td></tr>`;
          });
          testTableHtml += "</table>";
        }

        const paymentTableHtml =
          "<h3 style='text-align:center; margin-top:20px;'>Payment Details</h3>" +
          "<table style='width:100%; border-collapse:collapse; margin-bottom:20px;'>" +
          `<tr><td style='padding:8px;'>Payment Type</td><td style='padding:8px;'>${row.getAttribute("data-payment-type")}</td></tr>` +
          `<tr><td style='padding:8px;'>Transaction Type</td><td style='padding:8px;'>${row.getAttribute("data-transaction-type")}</td></tr>` +
          `<tr><td style='padding:8px;'>Discount Type</td><td style='padding:8px;'>${row.getAttribute("data-discount-type")}</td></tr>` +
          `<tr><td style='padding:8px;'>Discount Rate</td><td style='padding:8px;'>${row.getAttribute("data-discount-rate")}</td></tr>` +
          `<tr><td style='padding:8px;'>Transaction Total</td><td style='padding:8px;'>${row.getAttribute("data-transaction-total")}</td></tr>` +
          `<tr><td style='padding:8px;'><strong>Discounted Total</strong></td><td style='padding:8px;'><strong>${row.getAttribute("data-discounted-total")}</strong></td></tr>` +
          "</table>";

        document.getElementById("receiptDetails").innerHTML = basicTableHtml + testTableHtml + paymentTableHtml;
      }
      document.getElementById("receiptModal").style.display = "block";
    };

    window.closeModal = function() {
      document.getElementById("receiptModal").style.display = "none";
    };

    window.printReceipt = function() {
      window.print();
    };

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById("receiptModal");
      if (event.target == modal) {
        modal.style.display = "none";
      }
    };

    window.printPhilhealthReport = function () {
    const logoUrl = "{% static 'images/mdc_logo.jpg' %}";
    const rows = document.querySelectorAll('#pane-transactions tbody tr');

    let html = `
      <div style='text-align:center; margin-bottom:10px;'>
        <img src='${logoUrl}' style='width:60px; height:auto;'>
        <h2 style='margin:5px 0;'>Mendoza Diagnostic Center</h2>
        <h3 style='margin:5px 0;'>Philhealth Transactions Report</h3>
        <p>Date: {{ selected_date }}</p>
      </div>
      <table style='width:100%; border-collapse:collapse; font-size:12px;'>
        <thead>
          <tr style='background:#007BFF; color:#fff;'>
            <th style='padding:6px; border:1px solid #ccc;'>Txn ID</th>
            <th style='padding:6px; border:1px solid #ccc;'>Date</th>
            <th style='padding:6px; border:1px solid #ccc;'>Patient</th>
            <th style='padding:6px; border:1px solid #ccc;'>Philhealth Type</th>
            <th style='padding:6px; border:1px solid #ccc;'>Discount</th>
            <th style='padding:6px; border:1px solid #ccc;'>Discounted Total</th>
            <th style='padding:6px; border:1px solid #ccc;'>Status</th>
          </tr>
        </thead>
        <tbody>
    `;

    rows.forEach(row => {
      html += `
        <tr>
          <td style='padding:6px; border:1px solid #ccc;'>${row.dataset.transactionId}</td>
          <td style='padding:6px; border:1px solid #ccc;'>${row.dataset.transactionDate}</td>
          <td style='padding:6px; border:1px solid #ccc;'>${row.dataset.patientName}</td>
          <td style='padding:6px; border:1px solid #ccc;'>
            ${row.dataset.isPhilhealth?.toLowerCase() === "true" ? "Philhealth" : ""}
            ${row.dataset.isPhilhealthFree?.toLowerCase() === "true" 
              ? (row.dataset.isPhilhealth?.toLowerCase() === "true" ? "<br>" : "") + "Philhealth Free" 
              : ""}
          </td>
          <td style='padding:6px; border:1px solid #ccc;'>${row.dataset.discountRate}</td>
          <td style='padding:6px; border:1px solid #ccc;'>${row.dataset.discountedTotal}</td>
          <td style='padding:6px; border:1px solid #ccc;'>${row.dataset.transactionStatus}</td>
        </tr>`;

        console.log("Transaction", row.dataset.transactionId)
        console.log("Philhealth", row.dataset.isPhilhealth)
        console.log("Philhealth Free", row.dataset.isPhilhealthFree)
    });

    html += `</tbody></table>`;

    const reportWindow = window.open('', '_blank', 'width=800,height=1000');
    reportWindow.document.write(`
      <html>
        <head>
          <title>Philhealth Report</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
            th { background-color: #007BFF; color: white; }
          </style>
        </head>
        <body>${html}</body>
      </html>
    `);
    reportWindow.document.close();
    reportWindow.focus();
    reportWindow.print();
    reportWindow.close();
  };

  });
</script>
{% endblock %}
