<!DOCTYPE html>
<html>
<head>
    <title>Transaction List</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border: 1px solid #ddd;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        th {
            background-color: #4CAF50;
            color: white;
        }
        .action-links a {
            text-decoration: none;
            margin-right: 10px;
        }
        .btn-danger {
            background-color: #f44336;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .nav {
            margin-bottom: 20px;
        }
        .nav a {
            margin-right: 15px;
        }
        /* Modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            /* Set the receipt width to 80mm */
            width: 80mm;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        /* When printing, force modal-content to be 80mm wide */
        @media print {
            .modal {display: block !important;}
            .modal-content {border: none; width: 80mm; margin: 0 auto; padding: 10px;}
        }
    </style>
</head>
<body>
    <div class="nav">
        <a href="{% url 'home' %}">Home</a>
        <form method="post" action="{% url 'logout' %}" style="display:inline;">
            {% csrf_token %}
            <button type="submit" style="background:none; border:none; color:blue; text-decoration:underline; cursor:pointer; padding:0;">Logout</button>
        </form>
    </div>

    <div class="header">
        <h1>Transaction List</h1>
        <a href="{% url 'transaction_new' %}" class="btn">Register New Transaction</a>
    </div>
    
    {% if transactions %}
    <table>
        <thead>
            <tr>
                <th>Transaction ID</th>
                <th>Patient Name</th>
                <th>Payment Type</th>
                <th>Transaction Type</th>
                <th>Transaction Purpose</th>
                <th>Transaction Status</th>
                <th>View</th>
                <th>Edit</th>
                <th>Print Receipt</th>
                <th>Delete</th>
            </tr>
        </thead>
        <tbody>
            {% for transaction in transactions %}
            <tr data-transaction-id="{{ transaction.id }}"
                data-patient-id="{{ transaction.patient.id }}"
                data-patient-name="{{ transaction.patient.last_name }}, {{ transaction.patient.first_name }}"
                data-address="{{ transaction.address }}"
                data-contact="{{ transaction.contact_no }}"
                data-age="{{ transaction.age }}"
                data-payment-type="{{ transaction.get_payment_type_display }}"
                data-transaction-type="{{ transaction.get_transaction_type_display }}"
                data-company-id="{{ transaction.company_id }}"
                data-company="{{ transaction.company }}"
                data-purpose="{{ transaction.get_transaction_purpose_display }}"
                data-drug-test="{{ transaction.has_drug_test|yesno:'Yes,No' }}"
                data-custody="{{ transaction.custody_control_form_submitted|yesno:'Yes,No' }}"
                data-transaction-date="{{ transaction.transaction_date }}"
                data-transaction-time="{{ transaction.transaction_time }}"
                data-transaction-status="{{ transaction.get_transaction_status_display }}"
                data-discount-type="{{ transaction.discount_type }}"
                data-discount-rate="₱ {{ transaction.discount_rate }}"
                data-transaction-total="₱ {{ transaction.transaction_total }}"
                data-discounted-total="₱ {{ transaction.discounted_total }}"
                data-test-details="{% for tt in transaction.transaction_tests.all %}{{ tt.test.test_name }} - ₱{{ tt.test_price }}{% if not forloop.last %}, {% endif %}{% endfor %}"
            >
                <td>{{ transaction.id }}</td>
                <td>{{ transaction.patient.last_name }}, {{ transaction.patient.first_name }}</td>
                <td>{{ transaction.payment_type }}</td>
                <td>{{ transaction.transaction_type }}</td>
                <td>{{ transaction.transaction_purpose }}</td>
                <td id="transaction-status-{{ transaction.id }}">{{ transaction.transaction_status }}</td>
                <td class="action-view">
                    <a href="{% url 'transaction_detail' transaction.id %}">View</a>
                </td>
                <td class="action-edit">
                    <a href="{% url 'transaction_edit' transaction.id %}">Edit</a>
                </td>
                <td class="action-receipt">
                    <a href="javascript:void(0)" onclick="printAcknowledgementReceipt({{ transaction.id }})">Print Receipt</a>
                </td>
                <td class="action-delete">
                    <a href="{% url 'transaction_delete' transaction.id %}" class="btn-danger">Delete</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No transactions registered yet.</p>
    {% endif %}

    <!-- Modal for receipt preview -->
    <div id="receiptModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div id="receiptDetails">
                <!-- Customized Receipt details will be inserted here -->
            </div>
            <button onclick="printReceipt()">Print/Save as PDF</button>
        </div>
    </div>

    <script>
        // Function to update the transaction status, build the receipt details, and show the modal
        function printAcknowledgementReceipt(transactionId) {
            // Optionally update the transaction status on the server via AJAX.
            // For demonstration, update the status in the UI.
            document.getElementById("transaction-status-" + transactionId).innerText = "Completed";
            
            // Locate the table row corresponding to the transaction using data attributes
            var row = document.querySelector('tr[data-transaction-id="' + transactionId + '"]');
            if (row) {
                // Build the main details table
                var detailsTableHtml = "<h2 style='text-align:center;'>Acknowledgement Receipt</h2>";
                detailsTableHtml += "<table style='width:100%; border-collapse:collapse; margin-bottom:20px;'>";
                detailsTableHtml += "<tr><th style='padding:8px; background:#f2f2f2;'>Field</th><th style='padding:8px; background:#f2f2f2;'>Value</th></tr>";
                detailsTableHtml += "<tr><td style='padding:8px;'>Transaction ID</td><td style='padding:8px;'>" + row.getAttribute("data-transaction-id") + "</td></tr>";
                detailsTableHtml += "<tr><td style='padding:8px;'>Patient ID</td><td style='padding:8px;'>" + row.getAttribute("data-patient-id") + "</td></tr>";
                detailsTableHtml += "<tr><td style='padding:8px;'>Patient Name</td><td style='padding:8px;'>" + row.getAttribute("data-patient-name") + "</td></tr>";
                detailsTableHtml += "<tr><td style='padding:8px;'>Address</td><td style='padding:8px;'>" + row.getAttribute("data-address") + "</td></tr>";
                detailsTableHtml += "<tr><td style='padding:8px;'>Contact Number</td><td style='padding:8px;'>" + row.getAttribute("data-contact") + "</td></tr>";
                detailsTableHtml += "<tr><td style='padding:8px;'>Age</td><td style='padding:8px;'>" + row.getAttribute("data-age") + "</td></tr>";
                detailsTableHtml += "<tr><td style='padding:8px;'>Payment Type</td><td style='padding:8px;'>" + row.getAttribute("data-payment-type") + "</td></tr>";
                detailsTableHtml += "<tr><td style='padding:8px;'>Transaction Type</td><td style='padding:8px;'>" + row.getAttribute("data-transaction-type") + "</td></tr>";
                detailsTableHtml += "<tr><td style='padding:8px;'>Company ID</td><td style='padding:8px;'>" + row.getAttribute("data-company-id") + "</td></tr>";
                detailsTableHtml += "<tr><td style='padding:8px;'>Company</td><td style='padding:8px;'>" + row.getAttribute("data-company") + "</td></tr>";
                detailsTableHtml += "<tr><td style='padding:8px;'>Transaction Purpose</td><td style='padding:8px;'>" + row.getAttribute("data-purpose") + "</td></tr>";
                detailsTableHtml += "<tr><td style='padding:8px;'>Has Drug Test</td><td style='padding:8px;'>" + row.getAttribute("data-drug-test") + "</td></tr>";
                detailsTableHtml += "<tr><td style='padding:8px;'>Custody Form Submitted</td><td style='padding:8px;'>" + row.getAttribute("data-custody") + "</td></tr>";
                detailsTableHtml += "<tr><td style='padding:8px;'>Transaction Date</td><td style='padding:8px;'>" + row.getAttribute("data-transaction-date") + "</td></tr>";
                detailsTableHtml += "<tr><td style='padding:8px;'>Transaction Time</td><td style='padding:8px;'>" + row.getAttribute("data-transaction-time") + "</td></tr>";
                detailsTableHtml += "<tr><td style='padding:8px;'>Transaction Status</td><td style='padding:8px;'>Completed</td></tr>";
                detailsTableHtml += "<tr><td style='padding:8px;'>Discount Type</td><td style='padding:8px;'>" + row.getAttribute("data-discount-type") + "</td></tr>";
                detailsTableHtml += "<tr><td style='padding:8px;'>Discount Rate</td><td style='padding:8px;'>" + row.getAttribute("data-discount-rate") + "</td></tr>";
                detailsTableHtml += "<tr><td style='padding:8px;'>Transaction Total</td><td style='padding:8px;'>" + row.getAttribute("data-transaction-total") + "</td></tr>";
                detailsTableHtml += "<tr><td style='padding:8px;'>Discounted Total</td><td style='padding:8px;'>" + row.getAttribute("data-discounted-total") + "</td></tr>";
                detailsTableHtml += "</table>";
                
                // Build the test details table (if available)
                var testDetails = row.getAttribute("data-test-details");
                var testTableHtml = "";
                if (testDetails && testDetails.trim().length > 0) {
                    testTableHtml += "<h3 style='text-align:center;'>Test Details</h3>";
                    testTableHtml += "<table style='width:100%; border-collapse:collapse;'>";
                    testTableHtml += "<tr><th style='padding:8px; background:#f2f2f2;'>Test Name</th><th style='padding:8px; background:#f2f2f2;'>Test Price</th></tr>";
                    // Split the comma-separated string into an array of tests
                    var testsArray = testDetails.split(",");
                    for (var i = 0; i < testsArray.length; i++) {
                        var testItem = testsArray[i].trim();
                        if (testItem) {
                            // Split each test item into test name and test price
                            var parts = testItem.split(" - ");
                            var testName = parts[0] ? parts[0].trim() : "";
                            var testPrice = parts[1] ? parts[1].trim() : "";
                            testTableHtml += "<tr><td style='padding:8px;'>" + testName + "</td><td style='padding:8px;'>" + testPrice + "</td></tr>";
                        }
                    }
                    testTableHtml += "</table>";
                }
                
                // Combine the tables into the final receipt HTML
                var receiptHtml = detailsTableHtml;
                if (testTableHtml) {
                    receiptHtml += testTableHtml;
                }
                
                document.getElementById("receiptDetails").innerHTML = receiptHtml;
            }
            // Display the modal
            document.getElementById("receiptModal").style.display = "block";
        }

        // Function to close the modal
        function closeModal() {
            document.getElementById("receiptModal").style.display = "none";
        }

        // Function to invoke the browser's print dialog
        function printReceipt() {
            window.print();
        }

        // Optional: Close modal if the user clicks outside the modal content
        window.onclick = function(event) {
            var modal = document.getElementById("receiptModal");
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    </script>
</body>
</html>
