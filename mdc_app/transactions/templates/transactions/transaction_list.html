<!DOCTYPE html>
<html>
<head>
    <title>Transaction List</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        th {
            background-color: #4CAF50;
            color: white;
        }
        .action-links a {
            text-decoration: none;
            margin-right: 10px;
        }
        .btn-danger {
            background-color: #f44336;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .nav {
            margin-bottom: 20px;
        }
        .nav a {
            margin-right: 15px;
        }
        /* Modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        @media print {
            .modal {display: block !important;}
            .modal-content {border: none; width: 100%;}
        }
    </style>
</head>
<body>
    <div class="nav">
        <a href="{% url 'home' %}">Home</a>
        <form method="post" action="{% url 'logout' %}" style="display:inline;">
            {% csrf_token %}
            <button type="submit" style="background:none; border:none; color:blue; text-decoration:underline; cursor:pointer; padding:0;">Logout</button>
        </form>
    </div>

    <div class="header">
        <h1>Transaction List</h1>
        <a href="{% url 'transaction_new' %}" class="btn">Register New Transaction</a>
    </div>
    
    {% if transactions %}
    <table>
        <thead>
            <tr>
                <th>Transaction ID</th>
                <th>Patient Name</th>
                <th>Payment Type</th>
                <th>Transaction Type</th>
                <th>Transaction Purpose</th>
                <th>Transaction Status</th>
                <th>View</th>
                <th>Edit</th>
                <th>Print Receipt</th>
                <th>Delete</th>
            </tr>
        </thead>
        <tbody>
            {% for transaction in transactions %}
            <tr data-transaction-id="{{ transaction.id }}">
                <td>{{ transaction.id }}</td>
                <td>{{ transaction.patient.last_name }}, {{ transaction.patient.first_name }}</td>
                <td>{{ transaction.payment_type }}</td>
                <td>{{ transaction.transaction_type }}</td>
                <td>{{ transaction.transaction_purpose }}</td>
                <td id="transaction-status-{{ transaction.id }}">{{ transaction.transaction_status }}</td>
                <td class="action-view">
                    <a href="{% url 'transaction_detail' transaction.id %}">View</a>
                </td>
                <td class="action-edit">
                    <a href="{% url 'transaction_edit' transaction.id %}">Edit</a>
                </td>
                <td class="action-receipt">
                    <a href="javascript:void(0)" onclick="printAcknowledgementReceipt({{ transaction.id }})">Print Receipt</a>
                </td>
                <td class="action-delete">
                    <a href="{% url 'transaction_delete' transaction.id %}" class="btn-danger">Delete</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No transactions registered yet.</p>
    {% endif %}

    <!-- Modal for receipt preview -->
    <div id="receiptModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div id="receiptDetails">
                <!-- Receipt details will be inserted here -->
            </div>
            <button onclick="printReceipt()">Print/Save as PDF</button>
        </div>
    </div>

    <script>
        // Function to update the transaction status, prepare receipt details, and show the modal
        function printAcknowledgementReceipt(transactionId) {
            // Ideally, perform an AJAX call here to update the status on the server.
            // For demonstration, we update the status directly in the UI.
            document.getElementById("transaction-status-" + transactionId).innerText = "Completed";
            
            // Locate the table row corresponding to the transaction using a data attribute
            var row = document.querySelector('tr[data-transaction-id="' + transactionId + '"]');
            if (row) {
                var cells = row.getElementsByTagName("td");
                var receiptHtml = "<h2>Acknowledgement Receipt</h2>";
                receiptHtml += "<p><strong>Transaction ID:</strong> " + cells[0].innerText + "</p>";
                receiptHtml += "<p><strong>Patient Name:</strong> " + cells[1].innerText + "</p>";
                receiptHtml += "<p><strong>Payment Type:</strong> " + cells[2].innerText + "</p>";
                receiptHtml += "<p><strong>Transaction Type:</strong> " + cells[3].innerText + "</p>";
                receiptHtml += "<p><strong>Transaction Purpose:</strong> " + cells[4].innerText + "</p>";
                receiptHtml += "<p><strong>Transaction Status:</strong> Completed</p>";
                document.getElementById("receiptDetails").innerHTML = receiptHtml;
            }
            // Display the modal
            document.getElementById("receiptModal").style.display = "block";
        }

        // Function to close the modal
        function closeModal() {
            document.getElementById("receiptModal").style.display = "none";
        }

        // Function to invoke the browser's print dialog
        function printReceipt() {
            window.print();
        }

        // Optional: Close modal if the user clicks outside the modal content
        window.onclick = function(event) {
            var modal = document.getElementById("receiptModal");
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    </script>
</body>
</html>
