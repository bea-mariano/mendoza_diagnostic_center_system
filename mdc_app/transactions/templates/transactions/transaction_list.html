{% extends 'base.html' %}
{% load static %}

{% block title %}All Transactions{% endblock %}

{% block extra_head %}
<style>
    .container {
        max-width: 80%;
        margin: 15px auto 30px auto;
        padding: 30px 40px;
    }

    h1 {
        text-align: center;
        margin-bottom: 40px;
        font-size: 2rem;
    }

    .btn {
      background-color: #4CAF50;
      color: #fff;
      padding: 12px 20px;
      border: none;
      border-radius: 4px;
      text-decoration: none;
      font-size: 1rem;
      white-space: nowrap;
    }

    .btn-action {
        display: inline-flex;
        justify-content: center;
        align-items: center;
        width: 40px;
        height: 40px;
        font-size: 1rem;
        border-radius: 4px;
        color: #fff;
        text-decoration: none;
        border: none;
        cursor: pointer;
    }

    .btn-view { background-color: #4CAF50; }
    .btn-edit { background-color: #FFC107; }
    .btn-print { background-color: #17A2B8; }
    .btn-delete { background-color: #DC3545; }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }

    th, td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #ccc;
    }

    th {
        background-color: #007BFF;
        color: white;
    }

    tr:hover {
        background-color: #f5f5f5;
    }

    th:nth-last-child(-n+4),
    td:nth-last-child(-n+4) {
        width: 10%;
        text-align: center;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
        background-color: #fff;
        margin: 10% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80mm;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .close:hover,
    .close:focus {
        color: #000;
        text-decoration: none;
    }

    @media print {
        /* set paper size */
        @page { size: 80mm auto; margin: 0; }

        /* hide everything by default */
        body * { visibility: hidden !important; }

        /* but show the receipt or sticker modal and its contents */
        #receiptModal, #stickerModal,
        #receiptModal *, #stickerModal * {
            visibility: visible !important;
        }

        #stickerModal .close {
            display: none !important;
        }

        /* position the modal at the top-left for printing */
        #receiptModal, #stickerModal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            background: #fff;
            z-index: 9999;
            display: block !important;
            
        }

        /* tighten up the print layout */
        .modal-content, .sticker-content {
            width: 40mm;
            margin: 0 auto;
            padding: 6px !important;
            border: none;
            box-shadow: none;
            page-break-after: avoid;
        }

        .modal-content {
            width: 80mm;
            margin: 0 auto;
            padding: 6px !important;
            border: none;
            box-shadow: none;
            page-break-after: avoid;
        }

        /* hide any UI you don’t want printed */
        .no-print { display: none !important; }
        }


    .action-group {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
    }

    .col-transaction-id { width: 4%; }

    .btn-lab { background-color: #6F42C1; }

    @media print {
        #receiptModal {
            width: 80mm;
        }
        .modal-content {
            padding: 6px !important;
            font-size: 12px !important;
        }
    }

</style>
{% endblock %}

{% block content %}
<h1>All Transactions</h1>
<div class="header" style="display: flex; align-items: center; margin-bottom: 20px;">
    <a href="{% url 'transaction_new' %}" class="btn">Create New Transaction</a>

    <form method="get" action="" style="margin-left: auto; display: flex; gap: 8px;">
      <input
        type="text"
        name="q"
        placeholder="Search by Txn ID or Patient ID/Name"
        value="{{ q }}"
        style="padding:8px; border:1px solid #ccc; border-radius:4px; width:220px;"
      />
      <button type="submit" class="btn">Search</button>
      {% if q %}
        <a href="{% url 'transaction_list' %}" class="btn" style="background:#6c757d;">Clear</a>
      {% endif %}
    </form>
</div>

{% if transactions %}
<table>
    <thead>
        <tr>
            <th></th>
            <th class="col-transaction-id">Txn ID</th>
            <th>Date</th>
            <th>Patient</th>
            <th style="width: 6%;">Payment Type</th>
            <th style="width: 6%;">Type</th>
            <th style="width: 25%;">Purpose</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
    {% for t in transactions %}
      <tr
        data-transaction-id="{{ t.id }}"
        data-patient-name="{{ t.patient.last_name }}, {{ t.patient.first_name }}"
        data-contact="{{ t.contact_no }}"
        data-company="{{ t.company }}"
        data-purpose="{{ t.transaction_purpose }}"
        data-transaction-date="{{ t.transaction_date }}"
        data-transaction-time="{{ t.transaction_time }}"
        data-test-details="{% for tt in t.transaction_tests.all %}{{ tt.test.test_name }} - ₱{{ tt.test_price }}{% if not forloop.last %}, {% endif %}{% endfor %}"
        data-payment-type="{{ t.get_payment_type_display }}"
        data-transaction-type="{{ t.get_transaction_type_display }}"
        data-discount-type="{{ t.discount_type }}"
        data-discount-rate="₱ {{ t.discount_rate }}"
        data-transaction-total="₱ {{ t.transaction_total }}"
        data-discounted-total="₱ {{ t.discounted_total }}"
        data-is-philhealth="{{ t.is_philhealth }}"
        data-is-philhealth-free="{{ t.is_philhealth_free }}"
        data-is-senior-citizen="{{ t.is_senior_citizen }}"
        data-is-pwd="{{ t.is_pwd }}"
      >
        <td>
          <a href="{% url 'transaction_detail' t.id %}" class="btn-view btn-action" title="View">
            <i class="fas fa-eye"></i>
          </a>
        </td>
        <td class="col-transaction-id">{{ t.id }}</td>
        <td>{{ t.transaction_date }}</td>
        <td>{{ t.patient.last_name }}, {{ t.patient.first_name }}</td>
        <td>{{ t.payment_type }}</td>
        <td>{{ t.transaction_type }}</td>
        <td>{{ t.transaction_purpose }}</td>
        <td id="transaction-status-{{ t.id }}">{{ t.transaction_status }}</td>
        <td style="text-align: right;">
          <div class="action-group">
            <a href="{% url 'transaction_edit' t.id %}" class="btn-edit btn-action" title="Edit">
              <i class="fas fa-pen"></i>
            </a>
            <a href="javascript:void(0)"
               onclick="printAcknowledgementReceipt({{ t.id }})"
               class="btn-print btn-action"
               title="Print Receipt">
              <i class="fas fa-print"></i>
            </a>
            <a href="{% url 'transaction_lab_pdf' t.id %}"
               target="_blank"
               class="btn-lab btn-action"
               title="Lab Worksheet">
              <i class="fas fa-vial"></i>
            </a>
            <button class="btn-print btn-action"
                    title="Print Sticker"
                    onclick="printSticker(
                      '{{ t.patient.first_name }}',
                      '{{ t.patient.last_name }}',
                      '{{ t.id }}',
                      '{{ t.patient.date_of_birth|date:'Y-m-d' }}'
                    )">
              <i class="fas fa-sticky-note"></i>
            </button>
            <a href="{% url 'transaction_delete' t.id %}" class="btn-delete btn-action" title="Delete">
              <i class="fas fa-trash"></i>
            </a>
          </div>
        </td>
      </tr>
    {% endfor %}
    </tbody>
</table>
{% else %}
  <p>No transactions registered yet.</p>
{% endif %}

<!-- Receipt Modal -->
<div id="receiptModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('receiptModal')">&times;</span>
    <div id="receiptDetails"></div>
    <button class="no-print" onclick="printSpecific('receiptModal')">
      Print/Save as PDF
    </button>
  </div>
</div>

<!-- Sticker Modal -->
<div id="stickerModal" class="modal">
  <div class="modal-content sticker-content">
    <span class="close" onclick="closeModal('stickerModal')">&times;</span>
    <div id="stickerDetails"></div>
    <button class="no-print" onclick="printSpecific('stickerModal')">
      Print Sticker
    </button>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const logoUrl = "{% static 'images/mdc_logo.jpg' %}";

  function getDiscountLabel(row) {
      if (row.dataset.isPhilhealthFree === "True") {
          return "Philhealth Free";
      } else if (row.dataset.isPhilhealth === "True") {
          return "Philhealth";
      } else if (row.dataset.isSeniorCitizen === "True") {
          return "Senior Citizen";
      } else if (row.dataset.isPwd === "True") {
          return "PWD";
      } else {
          return "No Discount";
      }
  }

  function printAcknowledgementReceipt(transactionId) {
      const row = document.querySelector(`tr[data-transaction-id="${transactionId}"]`);
      if (!row) return;

      const discountLabel = getDiscountLabel(row);
      const discountRate = row.getAttribute("data-discount-rate");

      let html = "<div style='font-family:\"Courier New\",monospace;font-size:14px;line-height:1.2;'>";
      html += "<div style='text-align:center;margin-bottom:5px;'><img src='" + logoUrl + "' style='width:50px;'></div>";
      html += "<div style='text-align:center;font-weight:bold;'>Mendoza Diagnostic Center</div>";
      html += "<div style='text-align:center;margin-bottom:10px;'>Acknowledgement Receipt</div>";

      html += `<strong>Transaction ID: ${row.getAttribute("data-transaction-id")}</strong><br>`;
      html += `<strong>Patient Name: ${row.getAttribute("data-patient-name")}</strong><br>`;
      html += `<strong>Contact Number: ${row.getAttribute("data-contact")}</strong><br>`;
      html += `<strong>Company: ${row.getAttribute("data-company")}</strong><br>`;
      html += `<strong>Package Name: ${row.getAttribute("data-purpose")}</strong><br>`;
      html += `<strong>Date: ${row.getAttribute("data-transaction-date")} ${row.getAttribute("data-transaction-time")}</strong><br><br>`;

      const tests = row.getAttribute("data-test-details");
      if (tests) {
        html += "<strong>Tests:</strong><br>";
        tests.split(",").forEach(item => {
          const [n, p] = item.split(" - ");
          html += `<strong>• ${n.trim()} — ${p.trim()}<br></strong>`;
        });
        html += "<br>";
      }

      html += "<strong>Payment:</strong><br>";
      html += `<strong>Type: ${row.getAttribute("data-payment-type")}</strong><br>`;
      html += `<strong>Txn Type: ${row.getAttribute("data-transaction-type")}</strong><br>`;
      html += `<strong>Discount: ${discountLabel} (${discountRate})</strong><br>`;
      html += `<strong>Total: ${row.getAttribute("data-transaction-total")}</strong><br>`;
      html += `<strong>Paid: ${row.getAttribute("data-discounted-total")}</strong><br>`;
      html += "</div>";

      document.getElementById("receiptDetails").innerHTML = html;
      document.getElementById("receiptModal").style.display = "block";
  }


  function printSticker(firstName, lastName, txnId, birthdate) {
    const today = new Date().toISOString().split("T")[0];
    const html = `
      <div style="font-family:'Courier New',monospace;font-size:13px;line-height:1.2;">
        <div><strong>${lastName},</strong></div>
        <div><strong>${firstName}</strong></div>
        <br>
        <div><strong>Txn ID:</strong> ${txnId}</div>
        <div><strong>DOB:</strong> ${birthdate}</div>
        <div><strong>Date:</strong> ${today}</div>
      </div>
    `;
    document.getElementById("stickerDetails").innerHTML = html;
    document.getElementById("stickerModal").style.display = "block";
  }

  function closeModal(id) {
    document.getElementById(id).style.display = "none";
  }

  window.onclick = e => {
    if (e.target.id === 'receiptModal') closeModal('receiptModal');
    if (e.target.id === 'stickerModal') closeModal('stickerModal');
  }

  function printSpecific(id) {
  // 1. Grab the modal node
  const modal = document.getElementById(id);
  // 2. Save original page
  const original = document.body.innerHTML;
  // 3. Clone the modal (including its ID)
  const clone = modal.cloneNode(true);
  // 4. Replace the body with just that clone
  document.body.innerHTML = '';
  document.body.appendChild(clone);
  // 5. Fire print
  window.print();
  // 6. Restore
  document.body.innerHTML = original;
}

</script>
{% endblock %}
